<script>
socket.on("container remove", function (id) {
	$("[data-ownedby='"+id+"']").remove();
    $("[data-id='"+id+"']").remove();
});

function getChildHtml(parentId, child, callback) {
	$.ajax({
		url: "/container/render/" + parentId + "/" + child.id,
	}).done(function (html) {
		callback(html, child);
	});
}

function containerUpdateItem(containerId, rootElement, child) {
	getChildHtml(containerId, child, function (html, ch) {
		addContainerChild(rootElement, html, ch);
	});
}

function containerLoadAllItems(containerId, rootElement) {
    $.ajax({
        url: "/container/items/" + containerId,
    }).done(function(items) {
        var total = 0;
        var results = [];
        
        for (var i=0;i<items.length;i++) {
            total++;
            var item = items[i];
            item.index = i;
            getChildHtml(containerId, item, function (html, child) {
                child.html = html;
                results.push(child);
                total--;
                if (total == 0) {
                    results.sort(function (a,b) {
                        if (a.order == b.order)
                            return a.index - b.index;
                        return a.order - b.order;
                    });
                    results.forEach(function (r) {
                        addContainerChild(rootElement, r.html, r);
                    });
                }
            });
        }
    });
}

function addContainerChild(rootElement, html, child) {
	var element = html.indexOf("<") == 0 ? $(html) : $("<div>" + html + "</div>");
    element.each(function (index) {
        $(this).attr(index == 0 ? 
            {"data-id": child.id, "data-order": child.order} : 
            {"data-ownedby": child.id});
    });

	var prevElement = $("[data-id='"+child.id+"']");
	if (prevElement.length > 0) {
        $("[data-ownedby='"+child.id+"']").remove();
		prevElement.replaceWith(element);
		return;
	}
	
	var prevChild = undefined;
	var children = rootElement.children();
	if (children.length == 0) {
		rootElement.append(element);
		return;
	}
	
	for (var i=0;i<children.length; i++) {
		child = $(children[i]);
		var order = child.attr("data-order");
		if (child.order < order) {
			if (prevChild)
				element.insertAfter(prevChild);
			else
				rootElement.prepend(element);
			return;
		}
		
		prevChild = child;
	}
	
	rootElement.append(element);
};

$.ajax({
	url: "/rootcontainer"
}).done(function (data) {
	$("body").append(data);
});
</script>